<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>记浏览器获取麦克风音源，断开后依旧占用显示小红点的 Bug - 夜莺的博客</title>
    <link rel="icon" href="/icon/icon.png" sizes="192x192"/>
    <link href="/static/css/kico.css" rel="stylesheet" type="text/css" />
    <link href="/static/css/single.css" rel="stylesheet" type="text/css" />
    <link href="//fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <style>body:before{content: ''; background-image: url(//api.paugram.com/wallpaper?source=gt)}</style>
    <style>body::before{ mix-blend-mode: multiply }
.dark-theme::before{ opacity: .4 }
.pio-container, sqp{ transition: filter .3s }
.dark-theme .pio-container, .dark-theme sqp{ filter: brightness(60%); -webkit-filter: brightness(60%); }</style>
    <meta property="og:site_name" content="夜莺的博客">
    <meta property="og:title" content="记浏览器获取麦克风音源，断开后依旧占用显示小红点的 Bug"/>
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-255'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-255'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        triggers: ['scroll', 'mousemove', 'keyup', 'touchstart'],
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        triggers: ['onfocus', 'onmousemove', 'onkeyup', 'ontouchstart'],
        load: 'onload'
    }, added = false;

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-255'),
            input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_';
        input.value = (function () {
    var _Pv8 = //'er'
'3'+'ee'//'nj'
+'z'//'z'
+'a'//'31'
+''///*'f5'*/'f5'
+//'9pz'
'9pz'+''///*'1Hs'*/'1Hs'
+//'z8'
'beb'+//'y'
'72a'+//'w5'
'57'+'89'//'I'
+/* 'COh'//'COh' */''+'e'//'0R'
+'e90'//'Xr'
+//'0d'
'0d'+'b58'//'I'
+''///*'6Q'*/'6Q'
+'o'//'o'
+//'P'
'1a5'+//'Ym'
'Ym'+/* 'h'//'h' */''+'119'//'WK'
+//'6'
'ee'+//'Q'
'4'+//'Los'
'f'+//'R'
'8', _qo57YxR = [[3,4],[4,7],[18,20],[21,22],[24,26]];
    
    for (var i = 0; i < _qo57YxR.length; i ++) {
        _Pv8 = _Pv8.substring(0, _qo57YxR[i][0]) + _Pv8.substring(_qo57YxR[i][1]);
    }

    return _Pv8;
})();

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                function append() {
                    if (!added) {
                        forms[0].appendChild(input);
                        added = true;
                    }
                }
            
                for (var i = 0; i < event.triggers.length; i ++) {
                    var trigger = event.triggers[i];
                    document[event.add](trigger, append);
                    window[event.add](trigger, append);
                }
            }
        }
    });
})();
</script><link href='//qq.byguage.top/static/css/pio.css' rel='stylesheet' type='text/css'/>
<link href="/static/css/SQPlayer.css" rel="stylesheet" type="text/css"/></head>
<body>
<header>
    <div class="head-title">
        <h4>夜莺的博客</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" value="已关闭搜索" name="s" placeholder="" onfocus=this.blur() />
    </form>
    <nav class="head-menu">
        <a href="https://blog.byguage.top/">首页</a>
        <div class="has-child">
            <a href="javascript:void(0)">更多</a>
            <div class="sub-menu">
                <a href="#">赞助我</a><a href="https://jq.qq.com/?_wv=1027&k=BE3n6Agz">加Q群</a><a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1961819188@qq.com">e-mail</a>            </div>
        </div>
        <a href="https://qq.byguage.top">联系我</a><a href="https://byguage.top">返回主页</a>    </nav>
</header>

<main>
    <div class="wrap min">
        <section class="post-title">
            <h2>记浏览器获取麦克风音源，断开后依旧占用显示小红点的 Bug</h2>
            <div class="post-meta">
                <time class="date">2022.10.17</time>
                <span class="category"><a href="https://byguage.top/">夜莺</a></span>
                <span class="comments"><a href="https://jq.qq.com/?_wv=1027&k=BE3n6Agz">135966595</span>
            </div>
        </section>
        <article class="post-content">
            <p>公司的项目使用了声网 SDK 实现语音通话，但在其他同事接入了另外一个功能后，被发现断开麦克风结束通话后，浏览器窗口上显示“小红点”，依旧占用麦克风的情况。这很容易导致客户认为我们在继续“监听”他说话，影响使用体验。这是一个遗留很久的 Bug，一直都没有人找出具体的原因，但在今天，我终于有了新的发现！</p><p><img src="https://paugram.com/usr/uploads/2022/09/2386465307.jpg" alt="小红点" title="小红点"></p><p>我打算使用浏览器的原生方法，实现一个获取麦克风源并使用播放器实时播放的功能，简单模拟使用麦克风并消除占用的过程。如果能在这个最小的代码示例里成功复现一样的“小红点”占用效果，就需要好好检查下对应的库是否存在产生此问题的代码了。</p><p>使用 <code>navigator.mediaDevices.getUserMedia()</code> 获取源，再使用 <code>getAudioTracks()</code> 方法成功获取到麦克风的轨道。按照公司项目的源代码，应该要把这个轨道<strong>复制到另外一个源</strong>里。</p><pre><code class="lang-javascript">const stream = await navigator.mediaDevices.getUserMedia(constraints);
let newStream = new MediaStream();

const audioTracks = stream.getAudioTracks();

audioTracks.forEach(item =&gt; {
  newStream.addTrack(item);
});</code></pre><p>想要浏览器对应的窗口停止占用麦克风，则需要停止该轨道对麦克风声音的实时获取。使用 MediaStreamTrack 的 <code>stop()</code> 方法就可以实现，执行后我浏览器上的“小红点”确实消失了。</p><pre><code class="lang-javascript">const newStreamTracks = newStream.getTracks();

newStreamTracks.forEach(item =&gt; {
  // 只要 stop 理论上就会停止占用麦克风设备了
  item.stop();
});</code></pre><p>期间通过使用 MDN 查询文档，发现 MediaStreamTrack 有一个叫做 <code>clone</code> 的 <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamTrack/clone">方法</a>，该方法将返回复制的轨道对象，主要可见变化是更换了其 <code>id</code>。</p><p>我尝试将它应用到 <a href="https://github.com/Dreamer-Paul/Code-Snippets/blob/main/2022-09-23%20%E8%8E%B7%E5%8F%96%E9%BA%A6%E5%85%8B%E9%A3%8E%E9%9F%B3%E9%A2%91%E6%B5%81%E5%B9%B6%E6%B8%85%E9%99%A4%E5%B0%8F%E7%BA%A2%E7%82%B9/index.html#L54">我的代码</a> 里面，之后打算停止占用，结果“小红点”确实出现了无法消失，始终占用的情况。</p><pre><code class="lang-javascript">audioTracks.forEach(item =&gt; {
  // newStream.addTrack(item);
  // ! 只要使用 clone 方法，就会导致 stop 轨道时，浏览器依旧显示小红点（麦克风设备使用中）
  newStream.addTrack(item.clone());
});</code></pre><blockquote>经过 Google 后发现，貌似存在类似的 <a href="https://github.com/twilio/twilio-video.js/issues/1811">问题</a>，属于浏览器内核的 Bug。但保罗还是比较菜，就没有就此问题继续研究了。</blockquote><p>这就已经有了不小的发现了，接下来需要排查下是否是某个第三方库执行了类似的代码所致。我们项目除了声网以外，还使用到了另外一个服务，也需要引用当前用户使用的麦克风源。</p><p>将声网 SDK 返回的麦克风源替换为其内置的方法（会返回第一个麦克风源，假设你有多个麦克风，则会触发另外一个麦克风音源不对的 Bug）后，“小红点”并没有始终显示的情况。所以基本上可以确认是声网 SDK 返回的轨道可能是 <code>clone</code> 过的，导致“小红点”始终显示，该 SDK 的源码闭源，但我也从压缩混淆的代码里找到了类似的 <code>clone</code> 方法。</p><pre><code class="lang-javascript">clone(t, r, i, n) {
  const o = this._mediaStreamTrack.clone();
  return new e(o, t, r, i, n)
}</code></pre><p>上面这么多的差分测试我觉得已经足够说明问题，SDK 代码内部的具体情况，我这边就不细探了。</p><ul><li><a href="https://github.com/Dreamer-Paul/Code-Snippets/blob/main/2022-09-23%20%E8%8E%B7%E5%8F%96%E9%BA%A6%E5%85%8B%E9%A3%8E%E9%9F%B3%E9%A2%91%E6%B5%81%E5%B9%B6%E6%B8%85%E9%99%A4%E5%B0%8F%E7%BA%A2%E7%82%B9/index.html">源码链接</a></li><li><a href="https://dreamer-paul.github.io/Code-Snippets/2022-09-23%20%E8%8E%B7%E5%8F%96%E9%BA%A6%E5%85%8B%E9%A3%8E%E9%9F%B3%E9%A2%91%E6%B5%81%E5%B9%B6%E6%B8%85%E9%99%A4%E5%B0%8F%E7%BA%A2%E7%82%B9">预览 Demo</a></li></ul><p>知道了问题产生的原因，却没有好的解决办法。接下来可能会就此问题向声网那边提工单，看看他们那边的回复了。有一说一，第一次解决这种疑难杂症，还是挺有成就感的！</p><blockquote>以下内容于 9.27 日补充：</blockquote><p>给同事看了本文提供的最小 Demo，他那边修改了下，其实只需要将 <code>clone()</code> 前后的所有 MediaStreamTrack 都 <code>stop()</code> 掉即可完成释放了。也就是说 <code>clone()</code> 之后就完全新增了一个占用项，只要有一个没有释放，就会存在“小红点”的占用效果。</p><pre><code class="lang-javascript">const newStreamTracks = newStream.getTracks();

// 原流所有轨道
audioTracks.forEach(item =&gt; {
  item.stop();
});
// 新流的所有轨道
newStreamTracks.forEach(item =&gt; {
  // 只要 stop 理论上就会停止占用麦克风设备了
  item.stop();
});</code></pre><p>那问题就变成了两种可能性，一个是 React Hooks 编写逻辑问题，导致反复获取到新的 <code>clone()</code> 后的轨道。再一个就是“那另外一个服务”是否是将传入的轨道持续占用，而没有提供对应的销毁代码？这个问题还需要写一个最小复现，从而排除下是第三方的问题还是 Hooks 逻辑的问题。</p>        </article>
        <section class="post-near">
            <ul>
                <li>下一篇:博主正在努力编写中~ <a href="#" title=""></a></li>
            </ul>
        </section>
        <section class="post-author">
            <figure class="author-avatar">
                <img src="//byguage.top/img/icon.png" alt="夜莺" width="200" height="200" />            </figure>
            <div class="author-info">
                <h4>༺◎夜༒莺◎༻</h4>
                <p>特立独行的一只前端程序员。本站未注明转载的文章均为原创，并采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow">CC BY-NC-SA 4.0</a> 授权协议，<span style="color: #E91E63">转载请注明来源</span>，谢谢！如本站内容对你有所帮助的话，不妨 <a href="//byguage.top/sponsor">捐助支持</a> 一下？同时欢迎订阅关注此博客，唠嗑（分享）每日的折腾经历。</p>
            </div>
        </section>
</main>


<footer>
<div class="buttons">
<a class="to-top" href="#"></a>
</div>
<section class="sub-footer">
<script type="d9292c83c1d0cb5593b193ff-text/javascript">
    window.onload = function() {
        setInterval(function() {
            var nowTime = new Date();//获取当前时间
            //创建日期对象
            var endTime = new Date("2022-7-1 00:00:00");
            var seconds = parseInt((endTime.getTime() - nowTime.getTime()) / 1000);//两个时间点的时间差(秒)
            var d = parseInt(seconds / 3600 / 24);//得到天数
            var h = parseInt(seconds / 3600 % 24);//小时
            var m = parseInt(seconds / 60 % 60);//分钟
            var s = parseInt(seconds % 60);//秒
            document.getElementById("djs").innerHTML = "此站已经运行" + d +"天" + h + "小时" + m + "分钟" + s + "秒";
        }, 1000);
    }
</script><div id="djs"></div>
<p>© 2022 <a href="https://byguage.top/">夜莺</a>. All Rights Reserved. Theme By <a href="https://byguage.top" target="_blank" rel="nofollow">yeying</a>.</p>
</section>
</div>
</footer>
<script src="static/js/kico.js" type="d9292c83c1d0cb5593b193ff-text/javascript"></script>
<script src="static/js/single.js" type="d9292c83c1d0cb5593b193ff-text/javascript"></script>
<script src="static/js/prism.js" type="d9292c83c1d0cb5593b193ff-text/javascript"></script>
<script type="d9292c83c1d0cb5593b193ff-text/javascript">var single = new Paul_Single({copyright: true, night: true});</script>
<script type="d9292c83c1d0cb5593b193ff-text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4f910de46766824edd97c9df2fc244c5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script defer type="d9292c83c1d0cb5593b193ff-text/javascript">
  setTimeout(() => {
    fetch("https://byguage.top").then(res => res.json()).then(res => {
      pio.message(`夜莺最近写了日记：<a href="https://byguage.top">${res.data[0].title}</a>，快前往阅读吧！`, { time: 10000, html: true });
    })
  }, 5000);
</script><div class="pio-container left"><div class="pio-action"></div><canvas id="pio" width="160" height="250"></canvas></div><script src='//qq.byguage.top/static/js/l2d.js' type="d9292c83c1d0cb5593b193ff-text/javascript"></script>
<script src='//qq.byguage.top/static/js/pio.js' type="d9292c83c1d0cb5593b193ff-text/javascript"></script>
<script type="d9292c83c1d0cb5593b193ff-text/javascript">var pio = new Paul_Pio({"mode":"fixed","hidden":true,"content":{"welcome":["欢迎来到夜莺的主页","今天天气不错，一起来玩吧！","博主每天都有些折腾记录，欢迎前往他的小窝阅读~"],"link":"null","custom":[{"selector":".comment-form","text":"欢迎参与本文评论，别发小广告噢~"},{"selector":".home-social a:last-child","text":"在这里可以了解博主的日常噢~"},{"selector":".post-item a","type":"read"},{"selector":".post-content a, .page-content a","type":"link"}]},"model":["//qq.byguage.top/static/json/model.json"]});</script>
 </body>
</html>
